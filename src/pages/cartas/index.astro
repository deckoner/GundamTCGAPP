---
import MainLayout from "../../layouts/MainLayout.astro";
import Filtros from "../../components/Filtros.astro";
import { fetchCartas } from "../../utils/cartasLogic";

const initialData = await fetchCartas({ page: 1, altArt: false });
const { cartas, hasMore, total } = initialData;
---

<MainLayout title="Cartas - GundamTCG">
  <Filtros />
  <div class="mt-4"></div>

  <section
    id="cartas-container"
    class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"
    aria-label="Lista de cartas"
    data-has-more={hasMore.toString()}
  >
    {
      cartas.map((carta) => {
        const imgSrc = `https://img.deckoner.com/${carta.img}.webp`;
        const isBeta = [15, 35, 42].includes(carta.belongs_gd_id ?? -1);
        const isAlt = carta.alt_art === true;
        let flagsHTML = "";

        if (isAlt) {
          flagsHTML += `
          <span class="absolute top-2 right-2 text-black bg-purple-500 text-white font-bold text-xs px-5 py-1 rounded z-10">
            ALT
          </span>
        `;
        }

        if (isBeta) {
          const betaTop = isAlt ? "top-10" : "top-2";
          flagsHTML += `
          <span class="absolute ${betaTop} right-2 text-black font-bold text-xs px-5 py-1 rounded z-10"
                style="background-color: var(--color-accent);">
            BETA
          </span>
        `;
        }

        return (
          <article class="group bg-background-secondary hover:shadow-glow hover:border-accent/30 relative flex flex-col overflow-hidden rounded-xl border border-white/5 shadow-sm transition-all duration-300 hover:-translate-y-1">
            <a
              href={`/cartas/${encodeURIComponent(carta.gd ?? carta.name)}`}
              class="flex h-full flex-col"
            >
              <div class="relative aspect-[3/4] w-full overflow-hidden bg-gray-900">
                <img
                  src={imgSrc}
                  alt={carta.gd ?? carta.name}
                  class="h-full w-full object-contain transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                />
                <Fragment set:html={flagsHTML} />
              </div>
              <div class="flex flex-1 flex-col gap-2 p-4">
                <div>
                  <h2 class="text-text-primary group-hover:text-accent line-clamp-1 text-lg font-bold transition-colors">
                    {carta.name ?? ""}
                  </h2>
                  <p class="text-text-muted text-xs">{carta.gd}</p>
                </div>

                <div class="text-text-secondary flex items-center gap-2 text-xs">
                  <span class="text-accent font-medium">
                    {carta.rarity ?? "N/A"}
                  </span>
                  <span class="h-1 w-1 rounded-full bg-white/20" />
                  <span>Lvl {carta.level ?? "-"}</span>
                  <span class="h-1 w-1 rounded-full bg-white/20" />
                  <span>Cost {carta.cost ?? "-"}</span>
                </div>

                <div class="mt-auto flex flex-wrap gap-1.5 pt-2">
                  {carta.card_tags.map((ct) => (
                    <span class="border-accent/30 bg-accent/10 text-accent group-hover:border-accent/50 group-hover:bg-accent/20 rounded-full border px-2 py-0.5 text-[10px] font-semibold transition-colors">
                      {ct.tag?.tag ?? ""}
                    </span>
                  ))}
                </div>
              </div>
            </a>
          </article>
        );
      })
    }
  </section>
  <div
    id="loading"
    class="text-text-secondary hidden animate-pulse py-8 text-center"
  >
    <div
      class="border-accent inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
    >
    </div>
    <span class="ml-2 font-medium">Cargando cartas...</span>
  </div>

  <script>
    import { getCardFlagsHTML } from "../../utils/cardUtils";

    const container = document.getElementById("cartas-container");
    const loading = document.getElementById("loading");
    let page = 2;
    let hasMore = container?.dataset.hasMore === "true";
    let filtrosActuales = { altArt: false };
    let isLoading = false;
    let currentController = null;

    function renderCard(carta) {
      const article = document.createElement("article");
      article.className =
        "group relative flex flex-col overflow-hidden rounded-xl border border-white/5 bg-background-secondary shadow-sm transition-all duration-300 hover:-translate-y-1 hover:shadow-glow hover:border-accent/30";

      const tagsHTML = carta.card_tags
        .map(
          (ct) => `
            <span class="rounded-full border border-accent/30 bg-accent/10 px-2 py-0.5 text-[10px] font-semibold text-accent transition-colors group-hover:border-accent/50 group-hover:bg-accent/20">
              ${ct.tag?.tag ?? ""}
            </span>
          `,
        )
        .join("");

      const imgSrc = `https://img.deckoner.com/${carta.img}.webp`;
      const flagsHTML = getCardFlagsHTML(carta);
      article.innerHTML = `
          <a href="/cartas/${encodeURIComponent(carta.gd ?? carta.name)}" class="flex h-full flex-col">
            <div class="relative aspect-[3/4] w-full overflow-hidden bg-gray-900">
              <img src="${imgSrc}" alt="${carta.gd ?? carta.name}" class="h-full w-full object-contain transition-transform duration-500 group-hover:scale-105" loading="lazy"/>
              ${flagsHTML}
            </div>
            <div class="flex flex-1 flex-col gap-2 p-4">
              <div>
                <h2 class="text-lg font-bold text-text-primary line-clamp-1 group-hover:text-accent transition-colors">${carta.name ?? ""}</h2>
                <p class="text-xs text-text-muted">${carta.gd}</p>
              </div>
              
              <div class="flex items-center gap-2 text-xs text-text-secondary">
                <span class="font-medium text-accent">${carta.rarity ?? "N/A"}</span>
                <span class="h-1 w-1 rounded-full bg-white/20"></span>
                <span>Lvl ${carta.level ?? "-"}</span>
                <span class="h-1 w-1 rounded-full bg-white/20"></span>
                <span>Cost ${carta.cost ?? "-"}</span>
              </div>

              <div class="mt-auto flex flex-wrap gap-1.5 pt-2">
                ${tagsHTML}
              </div>
            </div>
          </a>
        `;
      return article;
    }

    async function loadCartas(filtros = {}, reset = false) {
      if (!hasMore && !reset) return;
      if (isLoading) return;

      isLoading = true;
      if (loading) loading.classList.remove("hidden");

      if (currentController) {
        try {
          currentController.abort();
        } catch (e) {}
      }
      currentController = new AbortController();

      const params = new URLSearchParams({ page: page.toString() });
      Object.entries(filtros).forEach(([key, val]) => {
        if (Array.isArray(val)) {
          val.forEach((v) => params.append(key, v.toString()));
        } else if (val || val === 0 || val === false) {
          params.append(key, val.toString());
        }
      });

      try {
        const res = await fetch(`/api/cartas?${params.toString()}`, {
          signal: currentController.signal,
        });

        if (!res.ok) throw new Error("Network response was not ok");

        const data = await res.json();

        if (reset && container) {
          container.innerHTML = "";
        }

        if (container) {
          data.cartas.forEach((carta) => {
            container.appendChild(renderCard(carta));
          });
        }

        page++;
        hasMore = data.hasMore;
      } catch (error) {
        if (error instanceof Error && error.name !== "AbortError") {
          console.error("Error cargando cartas:", error);
        }
      } finally {
        isLoading = false;
        if (loading) loading.classList.add("hidden");
      }
    }

    window.addEventListener("scroll", () => {
      if (
        window.innerHeight + window.scrollY >=
        document.body.offsetHeight - 500
      ) {
        loadCartas(filtrosActuales);
      }
    });

    window.addEventListener("aplicar-filtros", (e) => {
      if (currentController) {
        try {
          currentController.abort();
        } catch (err) {}
        currentController = null;
      }

      const customEvent = e as CustomEvent;
      filtrosActuales = customEvent.detail;
      page = 1;
      hasMore = true;
      isLoading = false;
      loadCartas(filtrosActuales, true);
    });

    // No es necesaria la carga inicial ya que se hace por SSR
  </script>
</MainLayout>
